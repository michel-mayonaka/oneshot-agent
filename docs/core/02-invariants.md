# 不変条件（must-not-break）

## I-01 入出力契約: run_dir と成果物
保証:
- run_dir は `ONESHOT_RUNS_DIR` 配下に作成されます。
- 省略時は `worklogs/` 配下になります。
- `oneshot-exec.sh` は `logs/` を作成します。
- `prompts/` と `inputs/` も作成します。
- `-C` 省略時は `artifacts/` を作成します。
- `run-oneshot.sh` は `worklogs/<spec>/<run_id>` を使います。
仮定:
- `ONESHOT_AGENT_ROOT` が設定済みです。
理由:
- 実行単位の境界を固定し、追跡を容易にします。
検証方法:
- 実行後に `worklogs/` 配下の構成を確認します。
安全な変更手順:
- 変更理由を ADR に記録します。
- 生成先の互換層を用意し、移行期間を設けます。
- `spec/` のテストを更新します。

## I-02 入力置換契約: __INPUT_<KEY>__
保証:
- `--input key=path` は `__INPUT_<KEY>__` を置換します。
- KEY は大文字化されます。
- パスは `ONESHOT_AGENT_ROOT` 基準で解決します。
- 置換した入力は `run-oneshot.sh` が記録します。
- 記録先は `inputs/inputs.txt` です。
仮定:
- 入力ファイルはテキストとして読めます。
理由:
- 監査可能な入力契約を維持するためです。
検証方法:
- `--render-only` で置換結果を確認します。
安全な変更手順:
- 置換仕様の互換層を先に実装します。
- 置換キーの移行ガイドを追加します。

## I-03 ログ契約: 形式 / 保存場所 / 保持
保証:
- `logs/events.jsonl` は JSONL 形式です。
- `logs/worklog.md` は Markdown 形式です。
- `logs/commands.jsonl` は JSONL 形式です。
- `logs/worklog.commands.md` は Markdown 形式です。
- `report.md` は run_dir 直下に生成されます。
- 自動削除は行いません。
仮定:
- `jq` が利用可能です。
- Codex 出力が JSONL で得られます。
- `worklogs/` は手動編集しません。
理由:
- 後追い調査と監査を成立させるためです。
検証方法:
- 既定の run で各ファイルの存在と形式を確認します。
安全な変更手順:
- 新旧形式の同時出力期間を設けます。
- README と docs を先に更新します。

## I-04 再現性: 期待値と揺らぎ
保証:
- `prompt.txt` が保存されます。
- `report.md` に `prompt_sha256` が記録されます。
仮定:
- モデル出力は非決定的です。
- 実行環境の差異が結果に影響します。
理由:
- 期待値を明示し、誤解を避けるためです。
検証方法:
- 同一プロンプトで複数回実行し差分を確認します。
安全な変更手順:
- 再現性の説明を docs に残します。
- ハッシュ計算の変更は ADR で合意します。

## I-05 失敗時ポリシー: リトライと介入
保証:
- 自動リトライやバックオフは行いません。
- 失敗時は終了コードが伝播します。
- エラーは `logs/stderr_and_time.txt` に残ります。
仮定:
- 人間がログを確認して復旧します。
理由:
- 失敗原因の見落としを避けるためです。
検証方法:
- 失敗ケースで終了コードとログを確認します。
安全な変更手順:
- 自動化を入れる前に手動復旧手順を更新します。
- 失敗時の通知設計を ADR に記録します。

## I-06 セキュリティ: 秘密情報とマスキング
保証:
- 自動マスキングは行いません。
- 環境変数のダンプ処理は実装していません。
- ログは平文で保存されます。
仮定:
- 利用者が秘密情報をプロンプトに含めません。
- `worklogs/` へのアクセスは適切に制御します。
理由:
- 監査と再現性を優先する設計のためです。
検証方法:
- ログに秘密が出ない運用をレビューします。
安全な変更手順:
- マスキング導入は段階的に行います。
- 影響範囲を `docs/` と ADR に記録します。
